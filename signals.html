<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Signals from ThePropHat.com</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body style="font-family:monospace; background:#fff; color:#000; margin:0; padding:0;">

<div class="signal-header">WOULDYOULIKETOSENDMEAMESSAGE?</div><br>

<div id="signal-feed" style="white-space:pre-wrap;"></div>

<form id="signal-form" style="margin-top:4px;">
  <input id="signal-name" type="text" placeholder="NAME" maxlength="20" style="width:80px;">
  <input id="signal-message" type="text" placeholder="MESSAGE" maxlength="1000" style="width:60%;">
  <button type="submit">↵</button>
</form>

<footer style="margin-top:8px;">
  <a href="https://theprophat.com/homepage.html">go back</a>
</footer>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCtlgNf9x8OnMGbeWePPgmyIeUOQ4sg20w",
  authDomain: "theprophatsignals.firebaseapp.com",
  databaseURL: "https://theprophatsignals-default-rtdb.firebaseio.com",
  projectId: "theprophatsignals",
  storageBucket: "theprophatsignals.firebasestorage.app",
  messagingSenderId: "416477268379",
  appId: "1:416477268379:web:ac81db12333f4699ceb93e"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const signalRef = db.ref("signalLog");

const feed = document.getElementById("signal-feed");

// Relative timestamp function
function formatTimestamp(ts) {
  const now = Date.now();
  const diff = now - ts;
  const seconds = Math.floor(diff / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);
  const days = Math.floor(hours / 24);

  if (seconds < 10) return 'just now';
  if (seconds < 60) return `${seconds}s ago`;
  if (minutes < 60) return `${minutes}m ago`;
  if (hours < 24) return `${hours}h ago`;
  if (days < 7) return `${days}d ago`;

  const d = new Date(ts);
  return `${d.toLocaleDateString()} @ ${d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`;
}

// Create message div with replies
function createSignalDiv(key, name, message, timestamp, replies = []) {
  const div = document.createElement("div");

  // Main message
  const header = document.createElement("div");
  header.textContent = `[${formatTimestamp(timestamp)}] ${name}: ${message}`;
  div.appendChild(header);

  // Replies container
  const replyContainer = document.createElement("div");

  if (replies.length === 1) {
    const r = replies[0];
    const replyDiv = document.createElement("div");
    replyDiv.style.color = "red"; // single reply in red
    replyDiv.textContent = `    ↳ [${formatTimestamp(r.timestamp)}] ${r.name}: ${r.message}`;
    replyContainer.appendChild(replyDiv);
  } else if (replies.length > 1) {
    const toggleBtn = document.createElement("span");
    toggleBtn.style.cursor = "pointer";
    toggleBtn.style.userSelect = "none";
    toggleBtn.style.color = "red"; // toggle text in red
    toggleBtn.textContent = `▶ ${replies.length} replies`;

    const drawer = document.createElement("div");
    drawer.style.display = "none";
    drawer.style.marginTop = "2px";
    drawer.style.color = "red"; // all replies in drawer are red

    replies.forEach(r => {
      const replyDiv = document.createElement("div");
      replyDiv.textContent = `    ↳ [${formatTimestamp(r.timestamp)}] ${r.name}: ${r.message}`;
      drawer.appendChild(replyDiv);
    });

    toggleBtn.addEventListener("click", () => {
      if (drawer.style.display === "none") {
        drawer.style.display = "block";
        toggleBtn.textContent = `▼ ${replies.length} replies`;
      } else {
        drawer.style.display = "none";
        toggleBtn.textContent = `▶ ${replies.length} replies`;
      }
    });

    replyContainer.appendChild(toggleBtn);
    replyContainer.appendChild(drawer);
  }

  div.appendChild(replyContainer);

  // Reply form
  const replyForm = document.createElement("form");
  replyForm.style.marginTop = "2px";

  const replyNameInput = document.createElement("input");
  replyNameInput.type = "text";
  replyNameInput.placeholder = "NAME";
  replyNameInput.maxLength = 20;
  replyNameInput.style.width = "80px";

  const replyMessageInput = document.createElement("input");
  replyMessageInput.type = "text";
  replyMessageInput.placeholder = "reply...";
  replyMessageInput.maxLength = 500;
  replyMessageInput.style.width = "60%";

  const replyBtn = document.createElement("button");
  replyBtn.type = "submit";
  replyBtn.textContent = "↵";

  replyForm.appendChild(replyNameInput);
  replyForm.appendChild(replyMessageInput);
  replyForm.appendChild(replyBtn);

  replyForm.addEventListener("submit", function(e) {
    e.preventDefault();
    const replyMsg = replyMessageInput.value.trim();
    if (!replyMsg) return;
    const replyName = replyNameInput.value.trim() || "Anonymous";
    const replyObj = { name: replyName, message: replyMsg, timestamp: Date.now() };
    signalRef.child(key).child("replies").push(replyObj);
    replyMessageInput.value = "";
  });

  div.appendChild(replyForm);

  return div;
}

// Main message submit
document.getElementById("signal-form").addEventListener("submit", function(e) {
  e.preventDefault();
  const name = document.getElementById("signal-name").value || "Anonymous";
  const message = document.getElementById("signal-message").value.trim();
  if (!message) return;
  const signal = { name, message, timestamp: Date.now() };
  signalRef.push(signal);
  this.reset();
});

// Listen for messages + replies
signalRef.limitToLast(50).on("value", snapshot => {
  feed.innerHTML = "";
  snapshot.forEach(child => {
    const val = child.val();
    const replies = val.replies ? Object.entries(val.replies).map(([k,v]) => ({ ...v, _key: k })) : [];
    feed.appendChild(createSignalDiv(child.key, val.name, val.message, val.timestamp, replies));
  });
  feed.scrollTop = feed.scrollHeight;
});
</script>
</body>
</html>
